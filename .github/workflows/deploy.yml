jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install (with dev) and build
        run: |
          npm ci --no-audit --no-fund
          npm run build

      - name: Prune dev deps for runtime
        run: |
          npm ci --omit=dev --no-audit --no-fund

      - name: Pack artifact
        run: |
          tar -czf artifact.tar.gz \
            dist package.json package-lock.json \
            prisma \
            # mantenha .env no servidor; não inclua:
            # .env

      - name: Upload to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          source: 'artifact.tar.gz'
          target: '/var/www/otsem-api'

      - name: SSH & deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            set -e
            cd /var/www/otsem-api
            # manter .env e prisma/.env intocados
            tar -xzf artifact.tar.gz
            rm -f artifact.tar.gz

            # migrações com o schema da pasta prisma (usa prisma/.env do servidor)
            npx prisma migrate deploy --schema prisma/schema.prisma

            # PM2
            ENTRY="dist/main.js"
            [ -f dist/src/main.js ] && ENTRY="dist/src/main.js"
            pm2 reload otsem-api --update-env --cwd /var/www/otsem-api --time || \
            pm2 start "$ENTRY" --name otsem-api --cwd /var/www/otsem-api
            pm2 save
